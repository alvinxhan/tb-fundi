import os
import sciris as sc
import neopatat
import numpy as np

year_to_hiv_prev_pars = {
    2014:{
    "hiv_prev":[0.007843, 0.011789, 0.013974, 0.016151, 0.020327, 0.027601, 0.029772, 0.032361, 0.033853, 0.034125, 0.034807, 0.033706, 0.032363, 0.030934, 0.029582, 0.029107, 0.032261, 0.039027, 0.048555, 0.05802, 0.067444, 0.080524, 0.093465, 0.105628, 0.116069, 0.127803, 0.139839, 0.152731, 0.166885, 0.181122, 0.193492, 0.20362, 0.211652, 0.218311, 0.223268, 0.225721, 0.226116, 0.224529, 0.22098, 0.216367, 0.211762, 0.207181, 0.202471, 0.197478, 0.191852, 0.186022, 0.179849, 0.173579, 0.167308, 0.161103, 0.154647, 0.148061, 0.141376, 0.134687, 0.127906, 0.121176, 0.114408, 0.107675, 0.100888, 0.094157, 0.087443, 0.080823, 0.074367, 0.068093, 0.062014, 0.056222, 0.050662, 0.045371, 0.040376, 0.035686, 0.031349, 0.027387, 0.023804, 0.020588, 0.017733, 0.015194, 0.012952, 0.010981, 0.009273, 0.007807, 0.006543, 0.005474, 0.004581, 0.003838, 0.003211, 0.002686, 0.002246, 0.001882, 0.001581, 0.001322, 0.000826, 0.000976, 0.000976, 0.000976, 0.000976, 0.000976, 0.000976, 0.000976, 0.000976, 0.000976],
    "art_prev":[0.41302, 0.38069, 0.35787, 0.39837, 0.42649, 0.46283, 0.47047, 0.45577, 0.44169, 0.44054, 0.43592, 0.47392, 0.49066, 0.50114, 0.49838, 0.45976, 0.3879, 0.29235, 0.21172, 0.16213, 0.13829, 0.13007, 0.13835, 0.15832, 0.18511, 0.21834, 0.25552, 0.29353, 0.33006, 0.36532, 0.39652, 0.42369, 0.44726, 0.46816, 0.4864, 0.50363, 0.51487, 0.52357, 0.52991, 0.5349, 0.5396, 0.54444, 0.54927, 0.55387, 0.55799, 0.56195, 0.56563, 0.5692, 0.57285, 0.57633, 0.57958, 0.58254, 0.58521, 0.58757, 0.58975, 0.59161, 0.5933, 0.59461, 0.59579, 0.59674, 0.59752, 0.59818, 0.5987, 0.59916, 0.59954, 0.59975, 0.5999, 0.59999, 0.60012, 0.60025, 0.60041, 0.60072, 0.60099, 0.60116, 0.60119, 0.60068, 0.59991, 0.59888, 0.59771, 0.59635, 0.59506, 0.59391, 0.59277, 0.59119, 0.58913, 0.58652, 0.58293, 0.57879, 0.57324, 0.5682, 0.52853, 0.50601, 0.50601, 0.50601, 0.50601, 0.50601, 0.50601, 0.50601, 0.50601, 0.50601]
    },
    2015:{
    "hiv_prev":[0.006045, 0.010936, 0.013362, 0.014217, 0.016017, 0.020182, 0.027404, 0.029552, 0.032104, 0.033575, 0.033846, 0.034319, 0.033295, 0.032099, 0.031246, 0.031705, 0.035033, 0.042289, 0.049792, 0.059424, 0.068387, 0.077038, 0.089627, 0.101946, 0.113386, 0.12315, 0.134198, 0.146153, 0.158869, 0.172817, 0.186826, 0.19883, 0.208542, 0.21615, 0.222437, 0.227021, 0.22909, 0.229137, 0.22725, 0.223428, 0.218612, 0.213812, 0.209012, 0.204092, 0.198915, 0.19312, 0.187109, 0.18083, 0.174415, 0.168018, 0.161662, 0.155109, 0.148439, 0.141683, 0.134933, 0.128059, 0.121305, 0.11447, 0.107704, 0.100883, 0.094114, 0.087393, 0.080754, 0.074276, 0.067982, 0.061903, 0.056102, 0.050545, 0.045254, 0.040256, 0.035569, 0.031246, 0.027284, 0.023711, 0.0205, 0.017651, 0.015114, 0.012887, 0.010922, 0.00922, 0.007757, 0.006504, 0.005437, 0.004548, 0.003804, 0.00318, 0.002655, 0.002217, 0.00185, 0.001545, 0.000928, 0.001083, 0.001083, 0.001083, 0.001083, 0.001083, 0.001083, 0.001083, 0.001083, 0.001083],
    "art_prev":[0.39473, 0.39055, 0.36408, 0.38017, 0.43108, 0.45302, 0.48303, 0.49224, 0.47857, 0.46505, 0.46424, 0.4935, 0.50893, 0.51883, 0.51835, 0.48518, 0.42182, 0.32809, 0.25976, 0.21016, 0.18588, 0.18024, 0.18593, 0.20369, 0.22995, 0.26025, 0.29517, 0.33115, 0.36675, 0.40012, 0.43185, 0.45991, 0.48412, 0.50509, 0.52381, 0.54295, 0.55564, 0.56593, 0.57396, 0.57986, 0.58454, 0.58897, 0.59353, 0.59807, 0.60237, 0.60623, 0.60993, 0.61337, 0.61672, 0.62015, 0.62342, 0.62645, 0.62917, 0.63159, 0.63374, 0.63573, 0.63741, 0.63894, 0.64009, 0.64113, 0.64195, 0.6426, 0.64312, 0.64352, 0.64388, 0.64413, 0.64427, 0.64437, 0.64443, 0.64452, 0.64464, 0.64474, 0.64502, 0.64524, 0.64538, 0.64535, 0.6448, 0.64398, 0.64296, 0.64181, 0.64047, 0.63925, 0.63822, 0.63721, 0.63574, 0.6338, 0.63148, 0.62821, 0.62443, 0.61921, 0.58191, 0.56092, 0.56092, 0.56092, 0.56092, 0.56092, 0.56092, 0.56092, 0.56092, 0.56092]
    },
    2016:{
    "hiv_prev":[0.005265, 0.008788, 0.012408, 0.013613, 0.014112, 0.015919, 0.020054, 0.027222, 0.029346, 0.031868, 0.033315, 0.033374, 0.033893, 0.03302, 0.032389, 0.033218, 0.03705, 0.044614, 0.052694, 0.059757, 0.069046, 0.077282, 0.085161, 0.097222, 0.108997, 0.119876, 0.129046, 0.140073, 0.151895, 0.1644, 0.178203, 0.191856, 0.203455, 0.21276, 0.220018, 0.225957, 0.230161, 0.231883, 0.231635, 0.229475, 0.225461, 0.220468, 0.21548, 0.210488, 0.205395, 0.200066, 0.194099, 0.187997, 0.181587, 0.175063, 0.168521, 0.162078, 0.155451, 0.148715, 0.141906, 0.135073, 0.128179, 0.121361, 0.114495, 0.107699, 0.10084, 0.094068, 0.08733, 0.080666, 0.074169, 0.067879, 0.061786, 0.05599, 0.050433, 0.045138, 0.040138, 0.035467, 0.031143, 0.027189, 0.023622, 0.020418, 0.017569, 0.015048, 0.012827, 0.010869, 0.00917, 0.007716, 0.006464, 0.005402, 0.004512, 0.003771, 0.003148, 0.002623, 0.00218, 0.001809, 0.00105, 0.001209, 0.001209, 0.001209, 0.001209, 0.001209, 0.001209, 0.001209, 0.001209, 0.001209],
    "art_prev":[0.4627, 0.37128, 0.37512, 0.39348, 0.42511, 0.46621, 0.48164, 0.51355, 0.52425, 0.5136, 0.50354, 0.51864, 0.52847, 0.53552, 0.53445, 0.50569, 0.46239, 0.37143, 0.30467, 0.26739, 0.24569, 0.24284, 0.25296, 0.27018, 0.29501, 0.32502, 0.35636, 0.38898, 0.42133, 0.45253, 0.48098, 0.5083, 0.53223, 0.55271, 0.57045, 0.58926, 0.60261, 0.61342, 0.6222, 0.62904, 0.634, 0.63791, 0.64159, 0.64537, 0.64912, 0.65265, 0.65579, 0.65881, 0.66162, 0.66437, 0.66721, 0.66989, 0.67232, 0.67446, 0.67635, 0.678, 0.67953, 0.68079, 0.68192, 0.6827, 0.68339, 0.68389, 0.68423, 0.68445, 0.68457, 0.68468, 0.68468, 0.68462, 0.68452, 0.68442, 0.68434, 0.68429, 0.68422, 0.68433, 0.68438, 0.68436, 0.68415, 0.68344, 0.68249, 0.68141, 0.68019, 0.67881, 0.67759, 0.67657, 0.6756, 0.67414, 0.67249, 0.67053, 0.66767, 0.66438, 0.62912, 0.61013, 0.61013, 0.61013, 0.61013, 0.61013, 0.61013, 0.61013, 0.61013, 0.61013]
    }
}

pop_pars = sc.objdict(
    datadir = "./data", # data directory
    year = 2014,
    place = "gauteng",
    # https://www.statssa.gov.za/publications/P0211/P02114thQuarter2011.pdf (ref A)
    # https://www.statssa.gov.za/publications/P0021/P00212011.pdf (ref B)
    wp_zipf_a = 0.983, # calculated based on 6,307,971 employed in 357,537 enterprises (ref B)
    verbose = 1,
)

if not os.path.isdir("./gauteng"):
    os.mkdir("./gauteng")

try:
    print ("Loading population object...")
    popobj = sc.load(filename = "./gauteng/pop.obj")
except:
    popobj = neopatat.Pop(pop_pars)
    sc.save(filename = "./gauteng/pop.obj", obj=popobj)

#raise Exception
sim_pars = sc.objdict(
    datadir = "./data", # data directory
    age_travel_fpath = "./data/gauteng_travel_data.xlsx",
    hiv_prev_pars = year_to_hiv_prev_pars[2014], # prevalence in adults (15+), ratio of children/adults LHIV from UNAIDS (https://www.unaids.org/en/resources/documents/2023/HIV_estimates_with_uncertainty_bounds_1990-present)
    hiv_sus_rr = 2.84,
    hiv_dea_rr = 6.5,
    nweeks = np.uint32(10 * 52), #np.uint32(3 * 52), # period in weeks
    setup_initial_states = 0,
    initial_state_dist = [0.2519, 0.1037, 0.0437, 0.0249, 0.378], # infection, minimal, subclinical, clinical, recovered
    initial_state_tau = [(3.61, 3.09), (8.39, 6.71), (3.31, 2.86), (7.13, 5.76), (5.68, 4.66)],
    district_mptb_prevalence = [149, 734, 522, 501, 603], # (per 100,000 people) tshwane, west rand, ekurhuleni, johannesburg, sedibeng
    beta = 1e-2, # per contact per week (to calibrate)
    ext_attack_rate = 1e-5, # external attack rate per person per week
)

for sim_i in range(10):
    print ('Starting epidemic simulation %02d...'%(sim_i))
    simobj = neopatat.Sim(sim_pars, pop = popobj)
    simobj.simulate(death_bool=1)
    sc.save(filename = "./gauteng/sim_%02d.obj"%(sim_i), obj=simobj)
    break
